<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
<title>Tracking numbers generator and checker</title>

<script language="javascript">
var services = {
	'China Post':['CN',['RH','RS']],
	'India': ['IN', ['ES', 'RS', 'CS']],
	'USPS':['US',['RA','EA']],
	'ePacket':['CN',['LM']],
};

var isoCountries = {
	'AF' : 'Afghanistan',
	'AX' : 'Aland Islands',
	'AL' : 'Albania',
	'DZ' : 'Algeria',
	'AS' : 'American Samoa',
	'AD' : 'Andorra',
	'AO' : 'Angola',
	'AI' : 'Anguilla',
	'AQ' : 'Antarctica',
	'AG' : 'Antigua And Barbuda',
	'AR' : 'Argentina',
	'AM' : 'Armenia',
	'AW' : 'Aruba',
	'AU' : 'Australia',
	'AT' : 'Austria',
	'AZ' : 'Azerbaijan',
	'BS' : 'Bahamas',
	'BH' : 'Bahrain',
	'BD' : 'Bangladesh',
	'BB' : 'Barbados',
	'BY' : 'Belarus',
	'BE' : 'Belgium',
	'BZ' : 'Belize',
	'BJ' : 'Benin',
	'BM' : 'Bermuda',
	'BT' : 'Bhutan',
	'BO' : 'Bolivia',
	'BA' : 'Bosnia And Herzegovina',
	'BW' : 'Botswana',
	'BV' : 'Bouvet Island',
	'BR' : 'Brazil',
	'IO' : 'British Indian Ocean Territory',
	'BN' : 'Brunei Darussalam',
	'BG' : 'Bulgaria',
	'BF' : 'Burkina Faso',
	'BI' : 'Burundi',
	'KH' : 'Cambodia',
	'CM' : 'Cameroon',
	'CA' : 'Canada',
	'CV' : 'Cape Verde',
	'KY' : 'Cayman Islands',
	'CF' : 'Central African Republic',
	'TD' : 'Chad',
	'CL' : 'Chile',
	'CN' : 'China',
	'CX' : 'Christmas Island',
	'CC' : 'Cocos (Keeling) Islands',
	'CO' : 'Colombia',
	'KM' : 'Comoros',
	'CG' : 'Congo',
	'CD' : 'Congo, Democratic Republic',
	'CK' : 'Cook Islands',
	'CR' : 'Costa Rica',
	'CI' : 'Cote D\'Ivoire',
	'HR' : 'Croatia',
	'CU' : 'Cuba',
	'CY' : 'Cyprus',
	'CZ' : 'Czech Republic',
	'DK' : 'Denmark',
	'DJ' : 'Djibouti',
	'DM' : 'Dominica',
	'DO' : 'Dominican Republic',
	'EC' : 'Ecuador',
	'EG' : 'Egypt',
	'SV' : 'El Salvador',
	'GQ' : 'Equatorial Guinea',
	'ER' : 'Eritrea',
	'EE' : 'Estonia',
	'ET' : 'Ethiopia',
	'FK' : 'Falkland Islands (Malvinas)',
	'FO' : 'Faroe Islands',
	'FJ' : 'Fiji',
	'FI' : 'Finland',
	'FR' : 'France',
	'GF' : 'French Guiana',
	'PF' : 'French Polynesia',
	'TF' : 'French Southern Territories',
	'GA' : 'Gabon',
	'GM' : 'Gambia',
	'GE' : 'Georgia',
	'DE' : 'Germany',
	'GH' : 'Ghana',
	'GI' : 'Gibraltar',
	'GR' : 'Greece',
	'GL' : 'Greenland',
	'GD' : 'Grenada',
	'GP' : 'Guadeloupe',
	'GU' : 'Guam',
	'GT' : 'Guatemala',
	'GG' : 'Guernsey',
	'GN' : 'Guinea',
	'GW' : 'Guinea-Bissau',
	'GY' : 'Guyana',
	'HT' : 'Haiti',
	'HM' : 'Heard Island & Mcdonald Islands',
	'VA' : 'Holy See (Vatican City State)',
	'HN' : 'Honduras',
	'HK' : 'Hong Kong',
	'HU' : 'Hungary',
	'IS' : 'Iceland',
	'IN' : 'India',
	'ID' : 'Indonesia',
	'IR' : 'Iran, Islamic Republic Of',
	'IQ' : 'Iraq',
	'IE' : 'Ireland',
	'IM' : 'Isle Of Man',
	'IL' : 'Israel',
	'IT' : 'Italy',
	'JM' : 'Jamaica',
	'JP' : 'Japan',
	'JE' : 'Jersey',
	'JO' : 'Jordan',
	'KZ' : 'Kazakhstan',
	'KE' : 'Kenya',
	'KI' : 'Kiribati',
	'KR' : 'Korea',
	'KW' : 'Kuwait',
	'KG' : 'Kyrgyzstan',
	'LA' : 'Lao People\'s Democratic Republic',
	'LV' : 'Latvia',
	'LB' : 'Lebanon',
	'LS' : 'Lesotho',
	'LR' : 'Liberia',
	'LY' : 'Libyan Arab Jamahiriya',
	'LI' : 'Liechtenstein',
	'LT' : 'Lithuania',
	'LU' : 'Luxembourg',
	'MO' : 'Macao',
	'MK' : 'Macedonia',
	'MG' : 'Madagascar',
	'MW' : 'Malawi',
	'MY' : 'Malaysia',
	'MV' : 'Maldives',
	'ML' : 'Mali',
	'MT' : 'Malta',
	'MH' : 'Marshall Islands',
	'MQ' : 'Martinique',
	'MR' : 'Mauritania',
	'MU' : 'Mauritius',
	'YT' : 'Mayotte',
	'MX' : 'Mexico',
	'FM' : 'Micronesia, Federated States Of',
	'MD' : 'Moldova',
	'MC' : 'Monaco',
	'MN' : 'Mongolia',
	'ME' : 'Montenegro',
	'MS' : 'Montserrat',
	'MA' : 'Morocco',
	'MZ' : 'Mozambique',
	'MM' : 'Myanmar',
	'NA' : 'Namibia',
	'NR' : 'Nauru',
	'NP' : 'Nepal',
	'NL' : 'Netherlands',
	'AN' : 'Netherlands Antilles',
	'NC' : 'New Caledonia',
	'NZ' : 'New Zealand',
	'NI' : 'Nicaragua',
	'NE' : 'Niger',
	'NG' : 'Nigeria',
	'NU' : 'Niue',
	'NF' : 'Norfolk Island',
	'MP' : 'Northern Mariana Islands',
	'NO' : 'Norway',
	'OM' : 'Oman',
	'PK' : 'Pakistan',
	'PW' : 'Palau',
	'PS' : 'Palestinian Territory, Occupied',
	'PA' : 'Panama',
	'PG' : 'Papua New Guinea',
	'PY' : 'Paraguay',
	'PE' : 'Peru',
	'PH' : 'Philippines',
	'PN' : 'Pitcairn',
	'PL' : 'Poland',
	'PT' : 'Portugal',
	'PR' : 'Puerto Rico',
	'QA' : 'Qatar',
	'RE' : 'Reunion',
	'RO' : 'Romania',
	'RU' : 'Russian Federation',
	'RW' : 'Rwanda',
	'BL' : 'Saint Barthelemy',
	'SH' : 'Saint Helena',
	'KN' : 'Saint Kitts And Nevis',
	'LC' : 'Saint Lucia',
	'MF' : 'Saint Martin',
	'PM' : 'Saint Pierre And Miquelon',
	'VC' : 'Saint Vincent And Grenadines',
	'WS' : 'Samoa',
	'SM' : 'San Marino',
	'ST' : 'Sao Tome And Principe',
	'SA' : 'Saudi Arabia',
	'SN' : 'Senegal',
	'RS' : 'Serbia',
	'SC' : 'Seychelles',
	'SL' : 'Sierra Leone',
	'SG' : 'Singapore',
	'SK' : 'Slovakia',
	'SI' : 'Slovenia',
	'SB' : 'Solomon Islands',
	'SO' : 'Somalia',
	'ZA' : 'South Africa',
	'GS' : 'South Georgia And Sandwich Isl.',
	'ES' : 'Spain',
	'LK' : 'Sri Lanka',
	'SD' : 'Sudan',
	'SR' : 'Suriname',
	'SJ' : 'Svalbard And Jan Mayen',
	'SZ' : 'Swaziland',
	'SE' : 'Sweden',
	'CH' : 'Switzerland',
	'SY' : 'Syrian Arab Republic',
	'TW' : 'Taiwan',
	'TJ' : 'Tajikistan',
	'TZ' : 'Tanzania',
	'TH' : 'Thailand',
	'TL' : 'Timor-Leste',
	'TG' : 'Togo',
	'TK' : 'Tokelau',
	'TO' : 'Tonga',
	'TT' : 'Trinidad And Tobago',
	'TN' : 'Tunisia',
	'TR' : 'Turkey',
	'TM' : 'Turkmenistan',
	'TC' : 'Turks And Caicos Islands',
	'TV' : 'Tuvalu',
	'UG' : 'Uganda',
	'UA' : 'Ukraine',
	'AE' : 'United Arab Emirates',
	'GB' : 'United Kingdom',
	'US' : 'United States',
	'UM' : 'United States Outlying Islands',
	'UY' : 'Uruguay',
	'UZ' : 'Uzbekistan',
	'VU' : 'Vanuatu',
	'VE' : 'Venezuela',
	'VN' : 'Viet Nam',
	'VG' : 'Virgin Islands, British',
	'VI' : 'Virgin Islands, U.S.',
	'WF' : 'Wallis And Futuna',
	'EH' : 'Western Sahara',
	'YE' : 'Yemen',
	'ZM' : 'Zambia',
	'ZW' : 'Zimbabwe'
};

function getCountryName(cc) {
	return isoCountries.hasOwnProperty(cc) ? isoCountries[cc] : cc;
}

var SICodes = [
	[['AV','AZ'],'domestic, bilateral, multilateral use only, identifing RFID-tracked e-commerce items'],
	[['BA','BZ'],'domestic, bilateral, multilateral use only'],
	[['CA','CZ'],'Parcel post; the use of CZ requires bilateral agreement. It is not required to use CV for insured parcels but if the service indicator CV is used, then it is recommended that it be used only on insured parcels.'],
	[['DA','DZ'],'for domestic, bilateral, multilateral use only'],
	[['EA','EZ'],'EMS; the use of EX-EZ requires bilateral agreement'],
	[['GA','GA'],'for domestic, bilateral, multilateral use only'],
	[['GD','GD'],'for domestic, bilateral, multilateral use only'],
	[['HA','HZ'],'e-commerce parcels; the use of HX-HY requires multilateral agreement; the use of HZ requires bilateral agreement'],
	[['JA','JZ'],'reserved; cannot be assigned as valid service indicator values'],
	[['KA','KZ'],'reserved; cannot be assigned as valid service indicator values'],
	[['LA','LZ'],'Letter post express; the use of LZ requires bilateral agreement'],
	[['MA','MZ'],'Letter post: M bags'],
	[['NA','NZ'],'for domestic, bilateral, multilateral use only'],
	[['PA','PZ'],'for domestic, bilateral, multilateral use only'],
	[['QA','QM'],'Letter post: IBRS (International Business Reply Service)'],
	[['RA','RZ'],'Letter post: registered, but not insured delivery. The use of RZ requires bilateral agreement.'],
	[['SA','SZ'],'reserved; cannot be assigned as valid service indicator values'],
	[['TA','TZ'],'reserved; cannot be assigned as valid service indicator values'],
	[['UA','UZ'],'Letter post: items other than LA-LZ (Express), MA-MZ (M bags), QA-QM (IBRS), RA-RZ (registered), VA-VZ (insured), subject to customs control, i.e. bearing a CN 22 or CN 23'],
	[['VA','VZ'],'Letter post insured; the use of VZ requires bilateral agreement'],
	[['WA','WZ'],'reserved; cannot be assigned as valid service indicator values'],
	[['ZA','ZZ'],'domestic, bilateral, multilateral use only'],
];

function getSICode(si) {
	for (var i=0; i<SICodes.length; i++) {
		var r = SICodes[i][0];
		var desc = SICodes[i][1];
		if (si>=r[0] && si<=r[1]) {
			return r[0]+'-'+r[1]+' (' + desc +')';
		}
	}
	return 'bad service indicator code';
}


function csum(sn) {
	var s = 0;
	var weight = [8, 6, 4, 2, 3, 5, 9, 7];
	for (var i=0; i<weight.length; i++) s += weight[i] * parseInt(sn[i]);
	var cs = 11 - (s % 11);
	return cs==10 ? 0 : cs==11 ? 5 : cs;
}

function gen_fake_serial() {
	var s = '';
	for (var i=0; i<8; i++) s += Math.floor(Math.random()*10);
	return s + csum(s);
}

function digits(num, count = 0){
   if(num){
      return digits(Math.floor(num / 10), ++count);
   };
   return count;
};

function verify() {
	var lines = document.getElementById("textarea").value.split('\n');
	var out = '';
	var errors = 0;
	for (var i=0; i<lines.length; i++) {
		s = lines[i];
		if (s) {
			var error = '';
			var info = '';
			var m = /^([A-Z]{2})(\d{8})(\d)([A-Z]{2})$/g.exec(s) || [];
			if (!m.length) {
				error = 'Wrong format, must be SI (2 chars) + SN (8 digits) + CS (1 digit) + CC (2 chars)';
			} else {
				var si = m[1];
				var sn = m[2];
				var cs = m[3];
				var cc = m[4];
				var csReal = csum(sn);
				if (csReal != cs) {
					error = 'Wrong Checksum (last digit is ' + cs + ', must be ' + csReal +')';
				}
				var cName = getCountryName(cc);
				info = cName==cc ? (' unknown country '+cc+', probably fake') : (' Country: '+ cName + ', SI Code: ' + getSICode(si));
			}
			out += s + ' <a target=_blank href="#'+s+'">'+(error ? error : 'Checksum OK') + '</a> '+info+'<br/>\n';
			if (error) errors++;
		}
	}
	document.getElementById("info").innerHTML = out;
	var e = document.getElementById("verify");
	e.style.display = 'inherit';
	e.className = e.className.replace( /red|green/g, errors ? 'red':'green');
}

function generate() {
	var n = parseInt(document.getElementById("n").value);
	var cc = document.getElementById("cc").value;
	var si = document.getElementById("si").value;
	var sf = document.getElementById("sf").value;
	var sn = false;
	if (sf) {
		if (sf.length == 8) {
			sn = sf
		} else {
			alert("8 digits for starting barcode")
			return
		}
	}
	var s = '';
	if (!sn) {
		for (var i = 0; i < n; i++) {
			s += si + gen_fake_serial() + cc + '\n'
		};
	}else{
		var serial = sn
		for (var i = 0; i < n; i++) {
			var str_serial = serial.toString()
			var sum = csum(str_serial)
			var code = str_serial + sum
			s += si + code + cc + '\n'
			serial = parseInt(serial) + 1
			digits(serial) < 8 ? serial = '0' + serial.toString() : serial.toString()
		};
	}
	document.getElementById("textarea").value = s;
}

function select() {
	var e = document.getElementById("services");
	var key = e.options[e.selectedIndex].value;
	document.getElementById("cc").value = services[key][0];
	document.getElementById("si").value = services[key][1][0];
}

function load() {
	var e = document.getElementById("services");
	for (var key in services) {
		var option = document.createElement("option");
		option.text = key;
		e.add(option);
	}
	select();
	var param = location.hash ? location.hash.slice(1) : '';
	if (param) {
		document.getElementById("textarea").value = param;
		verify();
	}
}

</script>
<body onload="load()">
<header class="w3-container">
  <h1>Tracking numbers generator and checker</h1>
  <p class="w3-large">This JavaScript project generates and verifies <a href="https://en.wikipedia.org/wiki/S10_(UPU_standard)">UPU S10</a> numbers used for tracking certain mail</p>
</header>

<div class="w3-container">
  <div id="verify" class="w3-panel w3-green w3-display-container" style="display:none">
    <span onclick="this.parentElement.style.display='none'" class="w3-button w3-large w3-display-topright">&times;</span>
    <h3>Verify</h3>
    <p id="info"></p>
  </div>
</div>

<div class="w3-row">
  <div class="w3-col m4 l3">
    <div class="w3-container">
      Service: <select class="w3-select" id="services" onchange="select()"></select>
      Country Code: <input class="w3-input" id="cc" type="text" value="US" size=2/>
      Service Indicator: <input class="w3-input" id="si" type="text" value="RA" size=2/>
      Start from (first 8 digits): <input class="w3-input" id="sf" type="number" size=2 />
      Quantity: <input class="w3-input" id="n" type="text" value="10" size=3/>
      <p><button class="w3-btn w3-block w3-red" onclick="generate()">Generate</button></p>
      <p><button class="w3-btn w3-block w3-blue" onclick="verify()">Verify</button></p>
    </div>
  </div>
  <div class="w3-col m8 l9">
    <div class="w3-container"><textarea class="w3-input w3-border" id="textarea" cols=30 rows=15 autofocus></textarea></div>
  </div>
</div>

</body>
</html>

